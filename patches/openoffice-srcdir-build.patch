From 1b9575e99a762d43789f1933bf23d6ecb5bb4a30 Mon Sep 17 00:00:00 2001
From: Jan Nieuwenhuizen <janneke@gnu.org>
Date: Fri, 3 Apr 2009 17:00:51 +0200
Subject: [PATCH] GUB3-[mingw-]cross-build: apply openoffice-srcdir-build.patch.

Update and apply patch from GUB3

    http://github.com/janneke/gub/blob/e0a39ff58bf4cbda742391e8bf3c099f8ffdcd01/patches/openoffice-srcdir-build.patch

fixes oot build, ie ./configure'ing of ooo-build with --srcdir.
---
 Makefile.shared     |   24 ++++++++++++------------
 bin/build-ooo       |    4 ++--
 bin/build-tools     |    2 +-
 bin/localize-ooo    |    4 ++--
 bin/ooinstall       |    2 +-
 bin/package-ooo     |    4 ++--
 bin/setup.in        |   33 +++++++++++++++++----------------
 bin/unpack          |    2 +-
 configure.in        |   11 ++++++-----
 desktop/Makefile.am |    2 +-
 10 files changed, 45 insertions(+), 43 deletions(-)

diff --git a/Makefile.shared b/Makefile.shared
index 761e542..b81739c 100644
--- a/Makefile.shared
+++ b/Makefile.shared
@@ -13,10 +13,10 @@ $(OOBUILDDIR)/unpack :
 	$(TOOLSDIR)/bin/transform --revert $(TOOLSDIR) $(OOBUILDDIR)
 	test -n "$(OOO_GIT)" && $(TOOLSDIR)/bin/gob --build-dir=$(OOBUILDDIR) prepare || true
 	if test -d $(OOBUILDDIR)/applied_patches ; then \
-		FLAGS=`$(TOOLSDIR)/bin/applyflags $(TOOLSDIR)/bin` ; \
-		chmod +x $(TOOLSDIR)/patches/apply.pl && $(TOOLSDIR)/patches/apply.pl $(APPLY_DIR) $(OOBUILDDIR) $$FLAGS -f -R ; \
+		FLAGS=`$(TOOLSDIR)/bin/applyflags $(TOP_BUILDDIR)/bin` ; \
+		chmod +x $(TOP_BUILDDIR)/patches/apply.pl && $(TOP_BUILDDIR)/patches/apply.pl $(APPLY_DIR) $(OOBUILDDIR) $$FLAGS -f -R ; \
 	fi
-	cd $(top_srcdir)/bin ; ./unpack
+	cd $(top_srcdir)/bin ; TOP_BUILDDIR=$(TOP_BUILDDIR) ./unpack
 	test -n "$(OOO_GIT)" && $(TOOLSDIR)/bin/gob --build-dir=$(OOBUILDDIR) postpare || true
 	rm -f $(STAMP_DIR)/build $(STAMP_DIR)/patch.apply \
 	      $(STAMP_DIR)/artwork.install
@@ -31,7 +31,7 @@ $(STAMP_DIR)/artwork.install : $(OOBUILDDIR)/unpack \
 	touch $@
 
 patch.apply: $(OOBUILDDIR)/unpack $(STAMP_DIR)/patch.apply 
-$(STAMP_DIR)/patch.apply : $(top_srcdir)/patches/apply.pl \
+$(STAMP_DIR)/patch.apply : $(TOP_BUILDDIR)/patches/apply.pl \
 			   $(top_srcdir)/patches/*/*.diff \
 			   $(APPLY_DIR)/apply
 	if test "z$(BUILD_WIN32)" != "z"; then \
@@ -47,8 +47,8 @@ $(STAMP_DIR)/patch.apply : $(top_srcdir)/patches/apply.pl \
 
 	$(TOOLSDIR)/bin/transform --revert $(TOOLSDIR) $(OOBUILDDIR)
 	test -n "$(OOO_GIT)" && $(TOOLSDIR)/bin/gob --build-dir=$(OOBUILDDIR) prepare || true
-	FLAGS=`$(TOOLSDIR)/bin/applyflags $(TOOLSDIR)/bin` ; \
-	chmod +x $(TOOLSDIR)/patches/apply.pl && $(TOOLSDIR)/patches/apply.pl $(APPLY_DIR) $(OOBUILDDIR) $$FLAGS --tag=$(CVSTAG) ;
+	FLAGS=`$(TOOLSDIR)/bin/applyflags $(TOP_BUILDDIR)/bin` ; \
+	chmod +x $(TOP_BUILDDIR)/patches/apply.pl && $(TOP_BUILDDIR)/patches/apply.pl $(APPLY_DIR) $(OOBUILDDIR) $$FLAGS --tag=$(CVSTAG) ;
 	test -n "$(OOO_GIT)" && $(TOOLSDIR)/bin/gob --build-dir=$(OOBUILDDIR) postpare || true
 	$(TOOLSDIR)/bin/transform --apply $(TOOLSDIR) $(OOBUILDDIR)
 	test -n "$(OOO_GIT)" && cd $(OOBUILDDIR) && git commit -am 'Font munging.' || true
@@ -58,8 +58,8 @@ $(STAMP_DIR)/patch.apply : $(top_srcdir)/patches/apply.pl \
 
 patch.unapply:
 	$(TOOLSDIR)/bin/transform --revert $(TOOLSDIR) $(OOBUILDDIR)
-	FLAGS=`$(TOOLSDIR)/bin/applyflags $(TOOLSDIR)/bin` ; \
-	chmod +x $(TOOLSDIR)/patches/apply.pl && $(TOOLSDIR)/patches/apply.pl $(APPLY_DIR) $(OOBUILDDIR) $$FLAGS -R ;
+	FLAGS=`$(TOOLSDIR)/bin/applyflags $(TOP_BUILDDIR)/bin` ; \
+	chmod +x $(TOP_BUILDDIR)/patches/apply.pl && $(TOP_BUILDDIR)/patches/apply.pl $(APPLY_DIR) $(OOBUILDDIR) $$FLAGS -R ;
 	rm -f $(STAMP_DIR)/patch.apply
 
 patch.list:
@@ -85,7 +85,7 @@ $(STAMP_DIR)/prebuild : $(OOBUILDDIR)/unpack
 
 build.tools : $(STAMP_DIR)/build.tools
 $(STAMP_DIR)/build.tools : $(STAMP_DIR)/prebuild
-	cd $(top_srcdir)/bin ; ./build-tools
+	cd $(top_srcdir)/bin ; TOP_BUILDDIR=$(TOP_BUILDDIR) ./build-tools
 	touch $@
 
 build : $(STAMP_DIR)/build
@@ -94,14 +94,14 @@ $(STAMP_DIR)/build : $(OOBUILDDIR)/unpack \
 		     $(STAMP_DIR)/artwork.install \
 		     $(STAMP_DIR)/build.tools \
 		     $(STAMP_DIR)/prebuild
-	cd $(top_srcdir)/bin ; ./build-ooo
+	cd $(top_srcdir)/bin ; TOP_BUILDDIR=$(TOP_BUILDDIR) ./build-ooo
 	touch $@
 
 all: build
 
 install: $(STAMP_DIR)/build
 if BUILD_WIN32
-	cd bin ; ./make-win32-iso
+	cd $(top_srcdir)/bin ; ./make-win32-iso
 else
-	cd bin ; ./package-ooo
+	cd $(top_srcdir)/bin ; TOP_BUILDDIR=$(TOP_BUILDDIR) ./package-ooo
 endif
diff --git a/bin/build-ooo b/bin/build-ooo
index 445f80a..da225f0 100755
--- a/bin/build-ooo
+++ b/bin/build-ooo
@@ -3,7 +3,7 @@
 #
 # See setup for user tweakables.
 #
-. ./setup
+. $TOP_BUILDDIR/bin/setup
 
 if test "z$BUILD_WIN32" = "z" -a "z`uname -s`" != "zSunOS" -a "z`uname -s`" != "zDarwin"; then
     if ! test -f /proc/cpuinfo; then
@@ -137,7 +137,7 @@ fi
 
 if test "z$PIECE" != "z"; then
 	echo "Build $PIECE"
-	. $TOOLSDIR/bin/piece/build-$PIECE
+	. $TOP_BUILDDIR/bin/piece/build-$PIECE
 else
 
 # update localizations from external sources
diff --git a/bin/build-tools b/bin/build-tools
index 525cde5..68d8806 100755
--- a/bin/build-tools
+++ b/bin/build-tools
@@ -3,7 +3,7 @@
 #
 # See setup for user tweakables.
 #
-. ./setup
+. $TOP_BUILDDIR/bin/setup
 
 if test "z$SYSTEM_GCC" != "z"; then
     echo "Not building gcc / binutils";
diff --git a/bin/localize-ooo b/bin/localize-ooo
index 78dc401..d24244c 100755
--- a/bin/localize-ooo
+++ b/bin/localize-ooo
@@ -15,9 +15,9 @@ if test -n "$OO_TOOLSDIR" ; then
     ALL_LANGS=`sed -n -e "s|^[[:space:]]*completelangiso=\(.*\)\(en-US \)\(.*\)$|\2\1\3|p" $SOLARENV/inc/postset.mk`
     split_build=yes
 else
-    . ./setup
+    . $TOP_BUILDDIR/bin/setup
     . $OOBUILDDIR/*.[sS]et.sh
-    . ./setup
+    . $TOP_BUILDDIR/bin/setup
     SRCDIR_PIECE=
     split_build=no
 fi
diff --git a/bin/ooinstall b/bin/ooinstall
index e3e0a73..0b05e43 100755
--- a/bin/ooinstall
+++ b/bin/ooinstall
@@ -45,7 +45,7 @@ sub wanted {
 
 ( $^O =~ /darwin/i ) || ( -f "/proc/meminfo" ) || die "The installer cannot work without javaldx running, which requires /proc to be mounted";
 
-suck_setup ("./setup") || suck_setup ("bin/setup") || die "can't find bin/setup";
+suck_setup ("./setup") || suck_setup ("bin/setup") || suck_setup ("$ENV{'TOP_BUILDDIR'}/bin/setup") || die "can't find bin/setup";
 
 print "Sucking env from build setup\n";
 my $fname = `ls $setup_vars{'OOBUILDDIR'}/*.[sS]et.sh`;
diff --git a/bin/package-ooo b/bin/package-ooo
index 189ce35..9f803bf 100755
--- a/bin/package-ooo
+++ b/bin/package-ooo
@@ -5,9 +5,9 @@
 #
 # See setup for user tweakables.
 #
-. ./setup
+. $TOP_BUILDDIR/bin/setup
 . $OOBUILDDIR/*.[sS]et.sh
-. ./setup
+. $TOP_BUILDDIR/bin/setup
 
 export LC_ALL='C';
 
diff --git a/bin/setup.in b/bin/setup.in
index 502054f..481c5fa 100644
--- a/bin/setup.in
+++ b/bin/setup.in
@@ -37,6 +37,7 @@ SPLIT_APP_MODULES='@SPLIT_APP_MODULES@'
 SPLIT_OPT_FEATURES='@SPLIT_OPT_FEATURES@'
 RUN_POST_INSTALL_SCRIPTS='@RUN_POST_INSTALL_SCRIPTS@'
 TOOLSDIR='@TOOLSDIR@'
+TOP_BUILDDIR='@TOP_BUILDDIR@'
 ENABLE_ODK='@ENABLE_ODK@'
 USE_PREBUILD_UNOWINREG_DLL='@USE_PREBUILD_UNOWINREG_DLL@'
 ENABLE_MONO='@ENABLE_MONO@'
@@ -67,39 +68,39 @@ GNUPATCH=@GNUPATCH@
 GNUTAR=@GNUTAR@
 DRINK="@DRINK@"
 
-if test -f "$TOOLSDIR/distro-configs/Common.conf" ; then
-    COMMON_OPTIONS="`cat $TOOLSDIR/distro-configs/Common.conf | xargs`";
+if test -f "$TOP_BUILDDIR/distro-configs/Common.conf" ; then
+    COMMON_OPTIONS="`cat $TOP_BUILDDIR/distro-configs/Common.conf | xargs`";
 else
-    echo "Warning: $TOOLSDIR/distro-configs/Common.conf not found."
+    echo "Warning: $TOP_BUILDDIR/distro-configs/Common.conf not found."
 fi
 
 if test "z$BUILD_WIN32" != "z"; then
-    if test -f "$TOOLSDIR/distro-configs/CommonWin32.conf" ; then
-        PLATFORM_OPTIONS="`cat $TOOLSDIR/distro-configs/CommonWin32.conf | xargs`";
+    if test -f "$TOP_BUILDDIR/distro-configs/CommonWin32.conf" ; then
+        PLATFORM_OPTIONS="`cat $TOP_BUILDDIR/distro-configs/CommonWin32.conf | xargs`";
     else
-        echo "Warning: $TOOLSDIR/distro-configs/CommonWin32.conf not found."
+        echo "Warning: $TOP_BUILDDIR/distro-configs/CommonWin32.conf not found."
     fi
 else if test "z`uname -s`" = "zDarwin"; then
-    if test -f "$TOOLSDIR/distro-configs/CommonMac.conf" ; then
-        PLATFORM_OPTIONS="`cat $TOOLSDIR/distro-configs/CommonMac.conf | xargs`";
+    if test -f "$TOP_BUILDDIR/distro-configs/CommonMac.conf" ; then
+        PLATFORM_OPTIONS="`cat $TOP_BUILDDIR/distro-configs/CommonMac.conf | xargs`";
     else
-        echo "Warning: $TOOLSDIR/distro-configs/CommonMac.conf not found."
+        echo "Warning: $TOP_BUILDDIR/distro-configs/CommonMac.conf not found."
     fi
 else
-    if test -f "$TOOLSDIR/distro-configs/CommonLinux.conf" ; then
-        PLATFORM_OPTIONS="`cat $TOOLSDIR/distro-configs/CommonLinux.conf | xargs`";
+    if test -f "$TOP_BUILDDIR/distro-configs/CommonLinux.conf" ; then
+        PLATFORM_OPTIONS="`cat $TOP_BUILDDIR/distro-configs/CommonLinux.conf | xargs`";
     else
-        echo "Warning: $TOOLSDIR/distro-configs/CommonLinux.conf not found."
+        echo "Warning: $TOP_BUILDDIR/distro-configs/CommonLinux.conf not found."
     fi
 fi
 fi
 
-if test "z$DISTRO" != "z" -a -f "$TOOLSDIR/distro-configs/$DISTRO.conf"; then
-    CONFIGURE_OPTIONS="$COMMON_OPTIONS $PLATFORM_OPTIONS $OOO_WIDGET_FLAGS `cat $TOOLSDIR/distro-configs/$DISTRO.conf | xargs`";
+if test "z$DISTRO" != "z" -a -f "$TOP_BUILDDIR/distro-configs/$DISTRO.conf"; then
+    CONFIGURE_OPTIONS="$COMMON_OPTIONS $PLATFORM_OPTIONS $OOO_WIDGET_FLAGS `cat $TOP_BUILDDIR/distro-configs/$DISTRO.conf | xargs`";
 else
     echo "ERROR: Could not find the distribution specific configure options"
-    echo "    file in $TOOLSDIR/distro-configs/."
-    echo "    $TOOLSDIR/distro-configs/$DISTRO.conf is probably missing."
+    echo "    file in $TOP_BUILDDIR/distro-configs/."
+    echo "    $TOP_BUILDDIR/distro-configs/$DISTRO.conf is probably missing."
 fi
 
 # Misc. internal
diff --git a/bin/unpack b/bin/unpack
index 453317c..d4b7d0d 100755
--- a/bin/unpack
+++ b/bin/unpack
@@ -3,7 +3,7 @@
 #
 # See setup for user tweakables.
 #
-. ./setup
+. $TOP_BUILDDIR/bin/setup
 
 if (echo "testing\c"; echo 1,2,3) | grep c >/dev/null; then
     if (echo -n testing; echo 1,2,3) | sed s/-n/xn/ | grep xn >/dev/null; then
@@ -57,7 +57,10 @@ if test "z$SPLIT" = "zyes" ; then
 	if test "z$PIECE" != "z"; then
 		CORE_PKGS=$PIECE
 	else
-		CORE_PKGS="sdk ure base calc help extras writer impress artwork filters testing bootstrap libs-gui libs-core libs-extern libs-extern-sys components postprocess extensions"
+		CORE_PKGS="sdk ure base calc help extras writer impress artwork filters testing bootstrap libs-gui libs-core libs-extern libs-extern-sys components postprocess"
+		if test "$ENABLE_EXTENSIONS" = "yes"; then
+		    CORE_PKGS="$CORE_PKGS extensions"
+		fi
 	fi
 	for pkg in $CORE_PKGS; do
 		check_tarball "$OOO_SPLIT_PREFIX$pkg.tar.bz2"

diff --git a/configure.in b/configure.in
index 090951b..f62b161 100644
--- a/configure.in
+++ b/configure.in
@@ -418,8 +418,8 @@ AM_MAINTAINER_MODE
 dnl
 dnl Setup the misc. tweaks we need.
 dnl
-BASEDIR=`pwd`
-TOOLSDIR=$BASEDIR
+TOP_BUILDDIR=`pwd`
+TOOLSDIR=$(cd $srcdir && pwd)
 
 # it will be modified by the --with-additional-sections but it might 
 # modified also by other options
@@ -528,7 +528,7 @@ warn_use_download="	./download
 "
 AC_MSG_CHECKING( for directory where to download sources )
 if test "z$with_srcdir" = "z"; then
-    SRCDIR=$BASEDIR/src
+    SRCDIR=$TOP_BUILDDIR/src
 elif (echo "${with_srcdir}" | $GREP -v -q "^/"); then
     AC_MSG_ERROR([--with-srcdir= must be an absolute path]);
 else
@@ -536,7 +536,7 @@ else
 fi
 AC_MSG_RESULT([$SRCDIR])
 
-BUILDDIR=$BASEDIR/build
+BUILDDIR=$TOP_BUILDDIR/build
 if test "z$with_ooo_builddir" = "z"; then
    OOBUILDDIR=$BUILDDIR/$CVSTAG
 else
@@ -554,9 +554,10 @@ if test "z`uname -s`" != "zSunOS" -a "z$with_win32" != "z" -a "z`uname -o`" = "z
     AC_MSG_RESULT([yes])
 fi
 
-rm -f $BASEDIR/stamp/patch.apply
+rm -f $TOP_BUILDDIR/stamp/patch.apply
 
 AC_SUBST(SRCDIR)
+AC_SUBST(TOP_BUILDDIR)
 AC_SUBST(BUILDDIR)
 AC_SUBST(TOOLSDIR)
 AC_SUBST(OOBUILDDIR)
diff --git a/desktop/Makefile.am b/desktop/Makefile.am
index 1f5cd71..26fecc4 100644
--- a/desktop/Makefile.am
+++ b/desktop/Makefile.am
@@ -1,6 +1,6 @@
 SUBDIRS=16x16 22x22 24x24 32x32 48x48 scalable mimetypes
 
-desktop_in_files = ${wildcard *.desktop.in.in}
+desktop_in_files = ${wildcard $(srcdir)/*.desktop.in.in}
 
 old_gnome_files = \
 	openoffice.applications.in \
diff --git a/patches/apply.pl.in b/patches/apply.pl.in
index 24bd678..e4f6e47 100755
--- a/patches/apply.pl.in
+++ b/patches/apply.pl.in
@@ -12,6 +12,8 @@ sub get_search_paths()
     my @paths = ();
     my @search = split (/:/, $options{'PATCHPATH'});
 
+    # Some patches are now generated by configure from *.in into build dir.
+    push @paths, '@TOP_BUILDDIR@/patches/dev300';
     for my $stem (@search) {
 	push @paths, "$patch_dir/$stem";
     }
